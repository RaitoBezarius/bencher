import RunMainStatistical from "../run-main-statistical.mdx";
import RunFeatureStatistical from "../run-feature-statistical.mdx";

## Statistical Continuous Benchmarking

Picking up where we left off in the
[Quick Start][quick start] and [Docker Self-Hosted][docker self-hosted] tutorials,
let's add Statistical [Continuous Benchmarking][continuous benchmarking] to our `Save Walter White` project.

> 🐰 Make sure you have
> [created an API token and set it as the `BENCHER_API_TOKEN` environment variable][create an api token]
> before continuing on!

[quick start]: /docs/tutorial/quick-start/
[docker self-hosted]: /docs/tutorial/docker/
[continuous benchmarking]: /docs/explanation/continuous-benchmarking/
[create an api token]: /docs/tutorial/quick-start/#create-an-api-token

Now we are ready to run our benchmarks in CI.
Because every CI environment is a little bit different,
the following example is meant to be more illustrative than practical.
For more specific examples, see [Continuous Benchmarking in GitHub Actions][github actions]
and [Continuous Benchmarking in GitLab CI/CD][gitlab ci/cd].

[github actions]: /docs/how-to/github-actions/
[gitlab ci/cd]: /docs/how-to/gitlab-ci-cd/

First, we need to create and maintain a historical baseline for our `main` branch by benchmarking every change in CI:

<RunMainStatistical />

1. Use the <code><a href="/docs/explanation/bencher-run/">bencher run</a></code> CLI subcommand
   to run your `feature-branch` branch benchmarks.
   See [the `bencher run` CLI subcommand][bencher run] for a full overview.
   (ex: `bencher run`)
2. Set the `--project` option to the Project slug.
   See [the `--project` docs][project option] for more details.
   (ex: `--project save-walter-white-1234abcd`)
3. Set the `--branch` option to the base Branch name.
   See [the `--branch` docs][branch option] for a full overview.
   (ex: `--branch main`)
4. Set the `--testbed` option to the CI runner Testbed name.
   See [the `--testbed` docs][testbed option] for more details.
   (ex: `--testbed ci-runner`)
5. Set the Threshold for the `main` Branch, `ci-runner` Testbed, and `latency` Measure:
   1. Set the `--threshold-measure` option to the built-in `latency` Measure that is generated by <code><a href="/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>.
   See [the `--threshold-measure` docs][threshold measure option] for more details.
   (ex: `--threshold-measure latency`)
   2. Set the `--threshold-test` option to a Student's t-test (`t_test`).
   See [the `--threshold-test` docs][threshold test option] for a full overview.
   (ex: `--threshold-test t_test`)
   3. Set the `--threshold-max-sample-size` option to the maximum sample size of `64`.
   See [the `--threshold-max-sample-size` docs][threshold max sample size] for more details.
   (ex: `--threshold-max-sample-size 64`)
   4. Set the `--threshold-upper-boundary` option to the Upper Boundary of `0.99`.
   See [the `--threshold-upper-boundary` docs][threshold upper boundary] for more details.
   (ex: `--threshold-upper-boundary 0.99`)
   5. Set the `--thresholds-reset` flag so that only the specified Threshold is active.
   See [the `--thresholds-reset` docs][thresholds reset] for a full overview.
   (ex: `--thresholds-reset`)
6. Set the `--err` flag to fail the command if an Alert is generated.
   See [the `--err` docs][alert err] for a full overview.
   (ex: `--err`)
7. Set the `--adapter` option to [Bencher Metric Format JSON (`json`)][bmf] that is generated by <code><a href="/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>.
   See [benchmark harness adapters][adapter json] for a full overview.
   (ex: `--adapter json`)
8. Specify the benchmark command arguments.
   See [benchmark command][command argument] for a full overview.
   (ex: `bencher mock`)

The first time this is command is run in CI,
it will create the `main` Branch if it does not exist yet.
The new `main` will _not_ have a start point or existing data.
A Threshold will be created for the `main` Branch, `ci-runner` Testbed, and `latency` Measure.
On subsequent runs, new data will be added to the `main` Branch.
The specified Threshold will then be used to detect performance regressions.

[bencher run]: /docs/explanation/bencher-run/
[project option]: /docs/explanation/bencher-run/#--project-project
[branch option]: /docs/explanation/branch-selection/#--branch-branch
[testbed option]: /docs/explanation/bencher-run/#--testbed-testbed
[threshold measure option]: /docs/explanation/thresholds/#--threshold-measure-measure
[threshold test option]: /docs/explanation/thresholds/#--threshold-test-test
[threshold max sample size]: /docs/explanation/thresholds/#--threshold-max-sample-size-size
[threshold upper boundary]: /docs/explanation/thresholds/#--threshold-upper-boundary-boundary
[thresholds reset]: /docs/explanation/thresholds/#--thresholds-reset
[alert err]: /docs/explanation/thresholds/#--err
[bmf]: /docs/reference/bencher-metric-format/
[adapter json]: /docs/explanation/adapters/#-json
[command argument]: /docs/explanation/bencher-run/#benchmark-command

Now, we are ready to catch performance regressions in CI.
This is how we would track the performance of a new feature branch in CI, aptly named `feature-branch`:

<RunFeatureStatistical />

1. Use the <code><a href="/docs/explanation/bencher-run/">bencher run</a></code> CLI subcommand
   to run your `feature-branch` branch benchmarks.
   See [the `bencher run` CLI subcommand][bencher run] for a full overview.
   (ex: `bencher run`)
2. Set the `--project` option to the Project slug.
   See [the `--project` docs][project option] for more details.
   (ex: `--project save-walter-white-1234abcd`)
3. Set the `--branch` option to the feature Branch name.
   See [the `--branch` docs][branch option] for a full overview.
   (ex: `--branch feature-branch`)
4. Set the Start Point for the `feature-branch` Branch:
   1. Set the `--start-point` option to the feature Branch start point.
   See [the `--start-point` docs][start point] for a full overview.
   (ex: `--start-point main`)
   2. Set the `--start-point-hash` option to the feature Branch start point `git` hash.
   See [the `--start-point-hash` docs][start point hash] for a full overview.
   (ex: `--start-point-hash 32ae...dd8b`)
   3. Set the `--start-point-clone-thresholds` flag to clone the Thresholds from the start point.
   See [the `--start-point-clone-thresholds` docs][start point clone thresholds] for a full overview.
   (ex: `--start-point-clone-thresholds`)
   4. Set the `--start-point-reset` flag to always reset the Branch to the start point.
   This will prevent benchmark data drift.
   See [the `--start-point-reset` docs][start point reset] for a full overview.
   (ex: `--start-point-reset`)
5. Set the `--testbed` option to the Testbed name.
   See [the `--tested` docs][testbed option] for more details.
   (ex: `--testbed ci-runner`)
6. Set the `--err` flag to fail the command if an Alert is generated.
   See [the `--err` docs][alert err] for a full overview.
   (ex: `--err`)
7. Set the `--adapter` option to [Bencher Metric Format JSON (`json`)][bmf] that is generated by <code><a href="/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>.
   See [benchmark harness adapters][adapter json] for a full overview.
   (ex: `--adapter json`)
8.  Specify the benchmark command arguments.
   See [benchmark command][command argument] for a full overview.
   (ex: `bencher mock`)

The first time this is command is run in CI,
Bencher will create the `feature-branch` Branch since it does not exist yet.
The new `feature-branch` will use the `main` Branch
at hash `32aea434d751648726097ed3ac760b57107edd8b` as its start point.
This means that `feature-branch` will have a copy of all the data and [Thresholds][thresholds]
from the `main` Branch to compare the results of `bencher mock` against.
On all subsequent runs, Bencher will reset the `feature-branch` Branch to the start point,
and use the `main` Branch data and Thresholds to detect performance regressions.

[start point]: /docs/explanation/branch-selection/#--start-point-branch
[start point hash]: /docs/explanation/branch-selection/#--start-point-hash-hash
[start point clone thresholds]: /docs/explanation/branch-selection/#--start-point-clone-thresholds
[start point reset]: /docs/explanation/branch-selection/#--start-point-reset
[thresholds]: /docs/explanation/thresholds/
