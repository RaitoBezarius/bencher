import MergeRequestsCode from "../merge-requests-code.mdx";
import MergeRequestsClosed from "./merge-requests-closed.mdx";

## Merge Requests

In order to catch performance regression in Merge Requests, you will need to run your benchmarks on MRs.
The below example should only be used for branches within the **same** repository.

<MergeRequestsCode />

1. Update the GitLab CI/CD file.
   (ex: `.gitlab-ci.yml`)
2. Create a GitLab CI/CD job.
   (ex: `benchmark_mr_branch`)
3. Run `if` the pipeline was triggered by a `merge_request_event`.
   See the [GitLab CI/CD `rules` documentation][gitlab ci cd rules]
   and [GitLab CI/CD predefined variables documentation][gitlab ci cd redefined variables] for a full overview.
   (ex: `rules: if: ...`)
4. Set the `image` the job will run in.
   See the [GitLab CI/CD `image` documentation][gitlab ci cd image]
   for a full overview.
   (ex: `image: debian:bullseye`)
5. Install the Bencher CLI using [the convenience script][install bencher cli].
   (ex: `before_script: ...`)
6. Use the <code><a href="/docs/explanation/bencher-run/">bencher run</a></code> CLI subcommand
   to run your merge request branch benchmarks.
   See [the `bencher run` CLI subcommand][bencher run] for a full overview.
   (ex: `bencher run`)
7. Set the `--project` option to the Project slug.
   See [the `--project` docs][project option] for more details.
   (ex: `--project project-abc4567-wxyz123456789`)
8. Set the `--token` option to the masked `BENCHER_API_TOKEN` environment variable.
   See [the `--token` docs][token option] for more details.
   (ex: `--token "$BENCHER_API_TOKEN"`)
9. Set the `--branch` option to the MR branch name
   using [a GitLab CI/CD predefined variable][gitlab ci cd redefined variables].
   See [the `--branch` docs][branch option] for a full overview.
   (ex: `--branch "$CI_COMMIT_REF_NAME"`)
10. Set the Start Point for the MR Branch:
    1. Set the `--start-point` option to the MR Branch start point
    using [a GitLab CI/CD predefined variable][gitlab ci cd redefined variables].
    See [the `--start-point` docs][start point] for a full overview.
    (ex: `--start-point "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"`)
    2. Set the `--start-point-hash` option to the MR Branch start point `git` hash
    using [a GitLab CI/CD predefined variable][gitlab ci cd redefined variables].
    See [the `--start-point-hash` docs][start point hash] for a full overview.
    (ex: `--start-point-hash "$CI_MERGE_REQUEST_TARGET_BRANCH_SHA"`)
    3. Set the `--start-point-clone-thresholds` flag to clone the Thresholds from the start point.
    See [the `--start-point-clone-thresholds` docs][start point clone thresholds] for a full overview.
    (ex: `--start-point-clone-thresholds`)
    4. Set the `--start-point-reset` flag to always reset the MR Branch to the start point.
    This will prevent benchmark data drift.
    See [the `--start-point-reset` docs][start point reset] for a full overview.
    (ex: `--start-point-reset`)
11. Set the `--testbed` option to the Testbed name.
   This should likely match the machine selected in `image`.
   See [the `--tested` docs][testbed option] for more details.
   (ex: `--testbed debian:bullseye`)
12. Set the `--err` flag to fail the command if an Alert is generated.
   See [the `--err` docs][alert err] for a full overview.
   (ex: `--err`)
13. Set the `--adapter` option to [Bencher Metric Format JSON (`json`)][bmf] that is generated by <code><a href="/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>.
   See [benchmark harness adapters][adapter json] for a full overview.
   (ex: `--adapter json`)
14. Specify the benchmark command arguments.
    See [benchmark command][command argument] for a full overview.
    (ex: <code><a href="/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>)

<MergeRequestsClosed />

[gitlab ci cd rules]: https://docs.gitlab.com/ee/ci/jobs/job_control.html#common-if-clauses-for-rules
[gitlab ci cd redefined variables]: https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
[gitlab ci cd image]: https://docs.gitlab.com/ee/ci/yaml/index.html#image

[install bencher cli]: /docs/how-to/install-cli/#install-cli-with-script
[bencher run]: /docs/explanation/bencher-run/
[project option]: /docs/explanation/bencher-run/#--project-project
[token option]: /docs/explanation/bencher-run/#--token-token
[branch option]: /docs/explanation/branch-selection/#--branch-branch
[start point]: /docs/explanation/branch-selection/#--start-point-branch
[start point hash]: /docs/explanation/branch-selection/#--start-point-hash-hash
[start point clone thresholds]: /docs/explanation/branch-selection/#--start-point-clone-thresholds
[start point reset]: /docs/explanation/branch-selection/#--start-point-reset
[testbed option]: /docs/explanation/bencher-run/#--testbed-testbed
[alert err]: /docs/explanation/thresholds/#--err
[bmf]: /docs/reference/bencher-metric-format/
[adapter json]: /docs/explanation/adapters/#-json
[github actions option]: /docs/explanation/bencher-run/#--github-actions-github_token
[command argument]: /docs/explanation/bencher-run/#benchmark-command
