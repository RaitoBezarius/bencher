## Фон

С самого начала я знал, что [API Bencher Perf][perf query] будет одним из самых требовательных к производительности конечных точек. Я считаю, что основная причина, по которой многим приходилось [изобретать колесо отслеживания бенчмарков заново][prior art], заключается в том, что существующие инструменты "из коробки" не справляются с необходимой высокой размерностью. Под "высокой размерностью" я понимаю возможность отслеживания производительности во времени и по нескольким измерениям: [Ветвлениям][branch], [Тестовым стендам][testbed], [Бенчмаркам][benchmarks] и [Метрикам][measures]. Эта возможность анализа данных по пяти различным измерениям приводит к очень сложной модели.

Именно из-за этой врожденной сложности и специфики данных я рассматривал возможность использования временной базы данных для Bencher. Однако в итоге я остановил свой выбор на SQLite. Я решил, что лучше [делать вещи, которые не масштабируются][do things that dont scale], чем тратить дополнительное время на изучение совершенно новой архитектуры базы данных, которая может и не помочь.

С течением времени требования к API Bencher Perf также возросли. Изначально вы должны были вручную выбрать все измерения, которые хотели визуализировать. Это создавало много трудностей для пользователей при попытке получить полезный график. Чтобы решить эту проблему, я [добавил список самых последних отчетов][github issue 133] на страницы Perf, и по умолчанию выбирался и отображался самый последний отчет. Это означало, что если в самом последнем отчете было 112 бенчмарков, то они все были бы визуализированы. Модель стала еще более сложной с возможностью отслеживания и визуализации [границ порогов][thresholds].

Имея это в виду, я внес несколько улучшений, связанных с производительностью. Поскольку для начала визуализации графика Perf требовался самый последний отчет, я рефакторил [API отчетов][reports api], чтобы получить данные результатов отчета одним вызовом к базе данных, вместо итерации. Временное окно для запроса отчета по умолчанию было установлено в четыре недели, вместо неограниченного. Я также значительно ограничил область всех дескрипторов базы данных, уменьшив конфликт блокировок. Чтобы помочь в общении с пользователями, я добавил индикатор состояния для [графика Perf][bencher v0317] и [вкладок измерений][bencher v045].

У меня также была неудачная попытка осенью использовать комбинированный запрос для получения всех результатов Perf одним запросом, вместо использования четырехкратного вложенного цикла. Это привело к тому, что я достиг [лимита рекурсии типовой системы Rust][recusion limit], постоянно переполнял стек, страдал из-за безумно долгих (намного более 38 секунд) времен компиляции и, наконец, зашел в тупик из-за [максимального количества терминов в составном выражении выборки SQLite][sqlite limits].

Со всем этим на своем счету, я знал, что мне действительно нужно здесь копнуть глубже и надеть штаны инженера по производительности. Я никогда раньше не профилировал базу данных SQLite, и, честно говоря, я никогда не профилировал _никакую_ базу данных до этого. Теперь подождите-ка, вы можете подумать. [Мой профиль в LinkedIn][linkedin epompeii] говорит, что я был "Администратором баз данных" почти два года. И я _никогда_ не профилировал базу данных‽ Да, это история на другой раз, предполагаю.

[do things that dont scale]: https://paulgraham.com/ds.html
[github issue 133]: https://github.com/bencherdev/bencher/issues/133
[recusion limit]: https://doc.rust-lang.org/reference/attributes/limits.html#the-recursion_limit-attribute
[sqlite limits]: https://www.sqlite.org/limits.html
[linkedin epompeii]: https://www.linkedin.com/in/epompeii/

[perf query]: /ru/docs/api/projects/perf/#get-v0projectsprojectperf
[prior art]: /ru/docs/reference/prior-art/#benchmark-tracking-tools
[branch]: /ru/docs/explanation/benchmarking/#branch
[testbed]: /ru/docs/explanation/benchmarking/#testbed
[benchmarks]: /ru/docs/explanation/benchmarking/#benchmark
[measures]: /ru/docs/explanation/benchmarking/#measure
[thresholds]: /ru/docs/explanation/thresholds/
[reports api]: /ru/docs/api/projects/reports/#get-v0projectsprojectreports
[bencher v0317]: /ru/docs/reference/changelog/#v0317
[bencher v045]: /ru/docs/reference/changelog/#v045