### База данных

Я старался сделать Bencher максимально простым.
Первая версия Bencher получала все данные,
включая результаты тестов, через параметры запроса URL.
Я быстро узнал, что все браузеры имеют [ограничение на длину URL][chrome url length].
Логично.

Затем я задумался о хранении результатов тестов в `git`
и просто генерировании статического HTML-файла с графиками и результатами.
Однако, у этого подхода есть два основных недостатка.
Во-первых, время `git clone` в конечном счете становится невыносимым для активных пользователей.
Во-вторых, все исторические данные должны присутствовать в HTML-файле,
что приводит к очень долгому времени начальной загрузки для активных пользователей.
Инструмент для разработки должен заботиться о своих активных пользователях, а не наказывать их.

Оказывается, есть решение моей проблемы.
Оно называется база данных.

Так почему бы просто не использовать Postgres и не успокоиться?
Ну, я действительно хотел, чтобы люди могли [самостоятельно размещать Bencher][bencher self hosted].
Чем проще я мог сделать архитектуру,
тем проще (и дешевле) было бы другим развертывать его у себя.
Я уже собирался требовать два контейнера из-за разделения фронтенда и бэкенда.
Могу ли я избежать третьего? Да!

До Bencher я использовал [SQLite][sqlite] только в качестве тестовой базы данных.
Опыт разработчика был фантастическим, но я никогда не думал о его использовании в производстве.
Затем я наткнулся на [Litestream][github litestream].
Litestream — это инструмент для восстановления после аварий для SQLite.
Он работает в фоне и непрерывно реплицирует изменения на S3
или в любое другое хранилище по вашему выбору.
Это делает его простым в использовании и невероятно экономичным в эксплуатации,
поскольку S3 не взимает плату за запись.
Думайте о центах в день для небольшого инстанса.

Когда я впервые наткнулся на Litestream,
также обещалось, что скоро появятся живые реплики для чтения.
Однако, этого [так и не произошло][litestream github issue 8].
Предлагаемая альтернатива была проектом-преемником того же разработчика
под названием [LiteFS][github litefs].
Однако у LiteFS есть серьезные недостатки.
Он не предлагает встроенного решения для восстановления после аварий, если все реплики выходят из строя.
Чтобы иметь несколько реплик,
вы должны внедрить в логику вашего приложения концепцию о том, является ли она читателем или писателем.
И абсолютным препятствием было то, что требует экземпляра [Consul][github consul],
который должен работать постоянно для управления репликами.
Вся суть использования SQLite заключалась в том, чтобы избежать ещё одной службы.
К счастью, я не пытался использовать LiteFS с Bencher Cloud,
поскольку [LiteFS Cloud был закрыт через год после запуска][litefs sunset],
а [LiteFS сейчас практически мёртв][github litefs contributors].

В настоящее время короткое время простоя между развертываниями [обрабатывается Bencher CLI][bencher attempts].
В будущем я планирую перейти к развертываниям без простоя, используя [Kamal][github kamal].
С учетом того, что [Rails 8.0 по умолчанию будет использовать Kamal и SQLite][rails 8],
я чувствую довольно уверенно, что Kamal и Litestream хорошо сработаются вместе.

> |    Технология    | Вердикт |
> | :--------------: | :-----: |
> | Параметры URL    |    ❌    |
> |    git + HTML    |    ❌    |
> |      SQLite      |    ✅    |
> |    Litestream    |    ✅    |
> |      LiteFS      |    ❌    |

[chrome url length]: https://chromium.googlesource.com/chromium/src/+/main/docs/security/url_display_guidelines/url_display_guidelines.md#url-length
[bencher self hosted]: /ru/docs/explanation/bencher-self-hosted/
[sqlite]: https://sqlite.org/
[github litestream]: https://github.com/benbjohnson/litestream
[litestream github issue 8]: https://github.com/benbjohnson/litestream/issues/8#issuecomment-1173214316
[github litefs]: https://github.com/superfly/litefs
[github consul]: https://github.com/hashicorp/consul
[litefs sunset]: https://community.fly.io/t/sunsetting-litefs-cloud/20829
[github litefs contributors]: https://github.com/superfly/litefs/graphs/contributors
[bencher attempts]: /ru/docs/explanation/bencher-run/#--attempts-count
[github kamal]: https://github.com/basecamp/kamal
[rails 8]: https://rubyonrails.org/2024/9/27/rails-8-beta1-no-paas-required
