---
title: "Criterion"
description: "Um guia passo a passo sobre como fazer benchmark de c√≥digo Rust com Criterion"
heading: "Como fazer benchmark de c√≥digo Rust com Criterion"
published: "2024-01-28T14:20:00Z"
modified: "2024-02-13T06:50:00Z"
sortOrder: 2
---

import Benchmarking from "../../../chunks/benchmarking/pt/benchmarking.mdx";
import FizzBuzzRules from "../../../chunks/benchmarking/pt/fizz-buzz-rules.mdx";
import FizzBuzzRust from "../../../chunks/rust/pt/fizz-buzz-rust.mdx";
import StepByStepRust from "../../../chunks/rust/pt/step-by-step-rust.mdx";
import MicroVsMacro from "../../../chunks/benchmarking/pt/micro-vs-macro.mdx";
import BenchmarkingRust from "../../../chunks/rust/pt/benchmarking-rust.mdx";
import FizzBuzzRefactor from "../../../chunks/rust/criterion/pt/fizz-buzz-refactor.mdx";
import GameBenchesTree from "../../../chunks/rust/criterion/game-benches-tree.mdx";
import FizzBuzzRefactorBenchesCode from "../../../chunks/rust/criterion/fizz-buzz-refactor-benches-code.mdx";
import GameCargoToml from "../../../chunks/rust/criterion/game-cargo-toml.mdx";
import BenchPlayGameOutput from "../../../chunks/rust/criterion/bench-play-game-output.mdx";
import FizzBuzzFibonacciRust from "../../../chunks/rust/pt/fizz-buzz-fibonacci-rust.mdx";
import PlayGameRustCode from "../../../chunks/rust/criterion/play-game-rust-code.mdx";
import BenchPlayGameFibonacciOutput from "../../../chunks/rust/criterion/bench-play-game-fibonacci-output.mdx";
import FizzBuzzFibonacciOpenRust from "../../../chunks/rust/pt/fizz-buzz-fibonacci-open-rust.mdx";
import FizzBuzzFibonacciOpenRustCode from "../../../chunks/rust/criterion/fizz-buzz-fibonacci-open-rust-code.mdx";
import TheEnd from "../../../chunks/benchmarking/pt/the-end.mdx";
import OnFire from "../../../chunks/benchmarking/pt/on-fire.mdx";
import BenchPlayGameOnFireCode from "../../../chunks/rust/criterion/bench-play-game-on-fire-code.mdx";
import BenchPlayGameOnFireOutputStart from "../../../chunks/rust/criterion/bench-play-game-on-fire-output-start.mdx";
import BenchPlayGameOnFireOutput from "../../../chunks/rust/criterion/bench-play-game-on-fire-output.mdx";
import FizzBuzzFibonacciFixRust from "../../../chunks/rust/pt/fizz-buzz-fibonacci-fix-rust.mdx";
import BenchPlayGameFixOutput from "../../../chunks/rust/criterion/bench-play-game-fix-output.mdx";
import CatchInCi from "../../../chunks/benchmarking/pt/catch-in-ci.mdx";
import CatchInCiOutput from "../../../chunks/rust/criterion/catch-in-ci-output.mdx";
import CatchInCiPlot from "../../../chunks/benchmarking/pt/catch-in-ci-plot.mdx";
import CatchInCiPlotRustBench from "../../../chunks/rust/catch-in-ci-plot-rust-bench.mdx";
import BencherFooter from "../../../chunks/learn/pt/bencher-footer.mdx";

<Benchmarking />

<FizzBuzzRust />

<StepByStepRust />

<MicroVsMacro />

<BenchmarkingRust />

Todos os tr√™s s√£o [suportados pelo Bencher](/pt/docs/explanation/adapters/). Ent√£o, por que escolher o Criterion?
Criterion √© o padr√£o de facto para realiza√ß√£o de benchmark na comunidade Rust.
Eu sugeriria o uso do Criterion para fazer benchmark da lat√™ncia do seu c√≥digo.
Ou seja, o Criterion √© √≥timo para medir o tempo de rel√≥gio.

<FizzBuzzRefactor />

## Benchmarking do FizzBuzz

Para fazer benchmark do nosso c√≥digo, precisamos criar um diret√≥rio `benches` e adicionar um arquivo para conter nossos benchmarks, `play_game.rs`:

<GameBenchesTree />

Dentro de `play_game.rs` adicione o seguinte c√≥digo:

<FizzBuzzRefactorBenchesCode />

- Importe o executor de benchmark `Criterion`.
- Importe a fun√ß√£o `play_game` da nossa crate `game`.
- Crie uma fun√ß√£o chamada `bench_play_game` que recebe uma refer√™ncia mut√°vel para `Criterion`.
- Use a inst√¢ncia `Criterion` (`c`) para criar um benchmark chamado `bench_play_game`.
- Em seguida, use o executor de benchmark (`b`) para executar nosso macro-benchmark v√°rias vezes.
- Execute nosso macro-benchmark dentro de uma "caixa preta" para que o compilador n√£o otimize nosso c√≥digo.
- Itere de `1` a `100` inclusivamente.
- Para cada n√∫mero, chame `play_game`, com `print` definido como `false`.

Agora precisamos configurar a crate `game` para executar nossos benchmarks.

Adicione o seguinte ao _final_ do seu arquivo `Cargo.toml`:

<GameCargoToml />

- `criterion`: Adicione `criterion` como uma depend√™ncia de desenvolvimento, pois estamos usando apenas para testes de performance.
- `bench`: Registre `play_game` como um benchmark e defina `harness` como `false`, pois usaremos o Criterion como nossa ferramenta de benchmarking.

Agora estamos prontos para fazer benchmark do nosso c√≥digo, execute `cargo bench`:

<BenchPlayGameOutput />

> üê∞ Vamos agitar a centr√≠fuga! Conseguimos nossas primeiras m√©tricas de benchmark!

Finalmente, podemos descansar nossas cansadas cabe√ßas de desenvolvedores...
Brincadeira, nossos usu√°rios querem um novo recurso!

<FizzBuzzFibonacciRust>
  <PlayGameRustCode />
</FizzBuzzFibonacciRust>

## Benchmarking do FizzBuzzFibonacci

Agora podemos reexecutar nosso benchmark:

<BenchPlayGameFibonacciOutput />

Oh, interessante! O Criterion nos informa que a diferen√ßa entre o desempenho dos nossos jogos FizzBuzz e FizzBuzzFibonacci √© `+568.69%`.
Seus n√∫meros ser√£o um pouco diferentes dos meus.
No entanto, a diferen√ßa entre os dois jogos provavelmente est√° na faixa de `5x`.
Isso me parece bom! Especialmente por adicionar um recurso t√£o sofisticado quanto _Fibonacci_ ao nosso jogo.
As crian√ßas v√£o adorar!

<FizzBuzzFibonacciOpenRust>
  <FizzBuzzFibonacciOpenRustCode />
</FizzBuzzFibonacciOpenRust>

<TheEnd />

<br />

<OnFire />

<BenchPlayGameOnFireCode />

- Um micro-benchmark `bench_play_game_100` para jogar o jogo com o n√∫mero cem (`100`)
- Um micro-benchmark `bench_play_game_1_000_000` para jogar o jogo com o n√∫mero um milh√£o (`1_000_000`)

Quando executei, obtive isto:

<BenchPlayGameOnFireOutputStart />

Aguarde... aguarde...

<BenchPlayGameOnFireOutput />

O qu√™! `403,57 ns` x `1,000` deveria ser `403.570 ns` e n√£o `9,596,800 ns` (`9.5968 ms` x `1_000_000 ns/1 ms`) ü§Ø 
Mesmo que eu tenha meu c√≥digo da sequ√™ncia de Fibonacci funcionando corretamente, devo ter algum bug de desempenho nele.

<FizzBuzzFibonacciFixRust />

Agora vamos reexecutar esses benchmark e ver como nos sa√≠mos:

<BenchPlayGameFixOutput />

Oh, uau! Nosso benchmark `bench_play_game` voltou para algo pr√≥ximo de onde estava para o FizzBuzz original.
Eu queria lembrar exatamente qual era esse score. Mas j√° se passaram tr√™s semanas.
Meu hist√≥rico de terminal n√£o vai t√£o longe.
E o Criterion s√≥ compara com o resultado mais recente.
Mas acho que est√° perto!

O benchmark `bench_play_game_100` est√° quase 10x para baixo, `-93.950%`.
E o benchmark `bench_play_game_1_000_000` est√° mais de 10,000x para baixo! `9,596,800 ns` para `30.403 ns`!
N√≥s at√© maximizamos o medidor de mudan√ßa do Criterion, que s√≥ vai at√© `-100.000%`!

> üê∞ Ei, pelo menos pegamos este bug de desempenho antes de ir para a produ√ß√£o... ah, certo. Esque√ßa...

<CatchInCi />

<CatchInCiOutput />

<CatchInCiPlot />

<CatchInCiPlotRustBench title="Como fazer Benchmark em Rust com Criterion" />

<BencherFooter />
